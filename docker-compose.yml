version: '2.2'

services:
  ci_mysql:
    image: mysql:5.7
    volumes:
      - ./mysql/data:/var/lib/mysql
    restart: always
    env_file: .env
    networks:
      ci:
        aliases:
          - ci_mysql

  ci_postgres:
    build: ./images/postgres
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
      - ./postgres/backups:/backups
    restart: always
    env_file: .env
    networks:
      ci:
        aliases:
          - ci_postgres

  ci_nginx:
    image: nginx
    volumes:
      - ./nginx/teamcity_reverse_proxy.template:/etc/nginx/conf.d/teamcity_reverse_proxy.template
    ports:
      - ${TEAMCITY_EXTERNAL_PORT_LISTEN_IP}:80:80
    env_file: .env
    restart: always
    command: /bin/bash -c "envsubst '$${TEAMCITY_EXTERNAL_HOSTNAME},$${TEAMCITY_EXTERNAL_PORT},$${SERVER_URL}' < /etc/nginx/conf.d/teamcity_reverse_proxy.template > /etc/nginx/conf.d/teamcity_reverse_proxy.conf && nginx-debug -g 'daemon off;'"
    networks:
      ci:
        aliases:
          - ci_nginx

  ci_mail:
    build: ./images/postfix
    env_file: .env
    restart: always
    networks:
      ci:
        aliases:
          - ci_postfix

  teamcity_server:
    container_name: teamcity-server
    image: jetbrains/teamcity-server:eap
    volumes:
      - ./teamcity/data:/data/teamcity_server/datadir
      - ./teamcity/logs:/opt/teamcity/logs
    env_file: .env
    restart: always
    networks:
      ci:
        aliases:
          - teamcity-server

  teamcity_agent:
    build: ./images/agent
    scale: 10
    env_file: .env
    volumes:
      - ./key:/key
    restart: always
    networks:
      - ci

networks:
  ci:
    driver: bridge
